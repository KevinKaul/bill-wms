// 仓库管理系统 Prisma Schema
// 基于产品需求文档设计的数据库结构

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 枚举类型定义
enum ProductType {
  RAW_MATERIAL    // 原材料
  FINISHED_PRODUCT // 组合产品（成品）
}

enum PaymentStatus {
  UNPAID  // 未付款
  PAID    // 已付款
}

enum DeliveryStatus {
  NOT_DELIVERED // 未到货
  DELIVERED     // 已到货
}

enum ProcessingStatus {
  PENDING     // 待处理
  IN_PROGRESS // 进行中
  COMPLETED   // 已完成
}

enum OperationType {
  CREATE // 新增
  UPDATE // 修改
  DELETE // 删除
}

// 1. 产品管理
model Product {
  id                String      @id @default(cuid())
  sku              String      @unique // 产品唯一标识符
  name             String      // 产品名称
  image            String?     // 产品图片URL
  type             ProductType // 产品类型
  description      String?     // 产品描述
  category_id      String?     // 分类ID
  status           String      @default("active") // 状态：active或inactive
  
  // 原材料字段
  referencePurchasePrice Decimal? @db.Decimal(10, 2) // 参考采购单价
  
  // 组合产品字段
  guidancePrice    Decimal?    @db.Decimal(10, 2) // 指导单价
  
  // 关联关系
  bomItems         BOMItem[]   @relation("ProductBOM") // 作为成品的BOM构成
  bomComponents    BOMItem[]   @relation("ComponentProduct") // 作为原材料的BOM组件
  purchaseItems    PurchaseOrderItem[]
  purchasePlanItems PurchasePlanItem[]
  rawMaterialBatches RawMaterialBatch[]
  finishedProductBatches FinishedProductBatch[]
  processOrders    ProcessOrder[]
  inventoryAdjustments InventoryAdjustment[]
  inventoryMovements InventoryMovement[]
  inventoryLevels InventoryLevel[]
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  
  @@map("products")
}

// BOM (Bill of Materials) - 产品构成
model BOMItem {
  id          String  @id @default(cuid())
  productId   String  // 成品ID
  componentId String  // 原材料ID
  quantity    Decimal @db.Decimal(10, 3) // 所需数量
  
  product     Product @relation("ProductBOM", fields: [productId], references: [id], onDelete: Cascade)
  component   Product @relation("ComponentProduct", fields: [componentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, componentId])
  @@map("bom_items")
}

// 2. 供应商管理
model Supplier {
  id          String @id @default(cuid())
  code        String @unique // 简称/代号
  fullName    String // 供应商全称
  account     String? // 银行账户
  type        String @default("material") // 类型：material、processing、both
  contact_person String? // 联系人
  phone       String? // 电话
  email       String? // 邮箱
  address     String? // 地址
  status      String @default("active") // 状态：active或inactive
  
  purchaseOrders PurchaseOrder[]
  processOrders  ProcessOrder[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("suppliers")
}

// 3. 采购管理 - 采购计划
model PurchasePlan {
  id              String    @id @default(cuid())
  planNumber      String    @unique // 计划编号
  title           String    // 计划标题
  status          String    @default("draft") // 状态：draft、approved、executed、cancelled
  totalEstimatedAmount Decimal @db.Decimal(10, 2) // 预估总金额
  remark          String?   // 备注
  createdById     String    // 创建人 ID
  createdByName   String    // 创建人名称
  approvedById    String?   // 批准人 ID
  approvedByName  String?   // 批准人名称
  executedAt      DateTime? // 执行时间
  
  items           PurchasePlanItem[] // 计划明细项
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("purchase_plans")
}

// 采购计划明细项
model PurchasePlanItem {
  id                String      @id @default(cuid())
  purchasePlanId    String      // 采购计划ID
  productId         String      // 产品ID
  quantity          Decimal     @db.Decimal(10, 3) // 计划采购数量
  estimatedUnitPrice Decimal    @db.Decimal(10, 2) // 预估单价
  estimatedTotalPrice Decimal   @db.Decimal(10, 2) // 预估总价
  remark            String?     // 备注
  
  purchasePlan      PurchasePlan @relation(fields: [purchasePlanId], references: [id], onDelete: Cascade)
  product           Product     @relation(fields: [productId], references: [id])
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("purchase_plan_items")
}

// 3. 采购管理 - 采购单
model PurchaseOrder {
  id              String        @id @default(cuid())
  orderNumber     String        @unique // 采购单号
  supplierId      String        // 供应商ID
  additionalPrice Decimal       @default(0) @db.Decimal(10, 2) // 附加价格（运费等）
  totalAmount     Decimal       @db.Decimal(10, 2) // 采购单总价
  status          String        @default("draft") // 状态：draft、confirmed、completed、cancelled
  paymentStatus   PaymentStatus @default(UNPAID) // 付款状态
  deliveryStatus  DeliveryStatus @default(NOT_DELIVERED) // 到货状态
  orderDate       DateTime      @default(now()) // 订单日期
  expectedDeliveryDate DateTime? // 预计到货日期
  actualDeliveryDate   DateTime? // 实际到货日期
  remark          String?       // 备注
  
  supplier        Supplier      @relation(fields: [supplierId], references: [id])
  items           PurchaseOrderItem[]
  rawMaterialBatches RawMaterialBatch[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("purchase_orders")
}

// 采购单明细
model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String        // 采购单ID
  productId       String        // 产品SKU ID
  quantity        Decimal       @db.Decimal(10, 3) // 采购数量
  unitPrice       Decimal       @db.Decimal(10, 2) // 采购单价
  totalPrice      Decimal       @db.Decimal(10, 2) // SKU总价
  
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product         Product       @relation(fields: [productId], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("purchase_order_items")
}

// 4. 产品加工 - 加工单
model ProcessOrder {
  id                String           @id @default(cuid())
  orderNumber       String           @unique // 加工单号
  productId         String           // 成品SKU ID
  plannedQuantity   Decimal          @db.Decimal(10, 3) // 计划生产数量
  actualQuantity    Decimal?         @db.Decimal(10, 3) // 实际产出数量
  materialCost      Decimal          @db.Decimal(10, 2) // 物料总成本
  processingFee     Decimal          @default(0) @db.Decimal(10, 2) // 其他加工费用
  totalCost         Decimal          @db.Decimal(10, 2) // 加工单总成本
  supplierId        String?          // 加工供应商ID（用于加工费结算）
  paymentStatus     PaymentStatus    @default(UNPAID) // 付款状态（针对加工费）
  status            ProcessingStatus @default(PENDING) // 加工状态
  orderDate         DateTime         @default(now()) // 订单日期
  startDate         DateTime?        // 开始生产日期
  completionDate    DateTime?        // 完成日期
  qualityStatus     String?          // 质量状态：passed或failed
  remark            String?          // 备注
  
  product           Product          @relation(fields: [productId], references: [id])
  supplier          Supplier?        @relation(fields: [supplierId], references: [id])
  materialUsages    MaterialUsage[]  // 物料使用记录
  finishedProductBatches FinishedProductBatch[]
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@map("process_orders")
}

// 物料使用记录（FIFO领料记录）
model MaterialUsage {
  id                   String             @id @default(cuid())
  processOrderId       String             // 加工单ID
  rawMaterialBatchId   String             // 原材料批次ID
  usedQuantity         Decimal            @db.Decimal(10, 3) // 使用数量
  unitCost             Decimal            @db.Decimal(10, 2) // 批次单价
  totalCost            Decimal            @db.Decimal(10, 2) // 使用总成本
  
  processOrder         ProcessOrder       @relation(fields: [processOrderId], references: [id], onDelete: Cascade)
  rawMaterialBatch     RawMaterialBatch   @relation(fields: [rawMaterialBatchId], references: [id])
  
  createdAt            DateTime           @default(now())
  
  @@map("material_usages")
}

// 5. 原材料库存管理（批次库存）
model RawMaterialBatch {
  id                String          @id @default(cuid())
  batchNumber       String          @unique // 批次号
  productId         String          // 原材料SKU ID
  purchaseOrderId   String          // 关联采购单ID
  inboundQuantity   Decimal         @db.Decimal(10, 3) // 入库数量
  remainingQuantity Decimal         @db.Decimal(10, 3) // 剩余数量
  actualUnitPrice   Decimal         @db.Decimal(10, 2) // 实际入库单价（含分摊费用）
  inboundDate       DateTime        @default(now()) // 入库日期
  
  product           Product         @relation(fields: [productId], references: [id])
  purchaseOrder     PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id])
  materialUsages    MaterialUsage[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("raw_material_batches")
}

// 6. 成品库存管理（批次库存）
model FinishedProductBatch {
  id                String       @id @default(cuid())
  batchNumber       String       @unique // 批次号
  productId         String       // 成品SKU ID
  processOrderId    String       // 关联加工单ID
  inboundQuantity   Decimal      @db.Decimal(10, 3) // 入库数量
  remainingQuantity Decimal      @db.Decimal(10, 3) // 剩余数量
  actualUnitCost    Decimal      @db.Decimal(10, 2) // 实际单位成本
  inboundDate       DateTime     @default(now()) // 入库日期
  
  product           Product      @relation(fields: [productId], references: [id])
  processOrder      ProcessOrder @relation(fields: [processOrderId], references: [id])
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@map("finished_product_batches")
}

// 7. 库存位置
model Location {
  id              String    @id @default(cuid())
  code            String    @unique // 位置编码
  name            String    // 位置名称
  type            String    // 位置类型：warehouse、shelf、bin
  parentId        String?   // 父级位置 ID
  capacity        Decimal?  @db.Decimal(10, 3) // 容量
  capacityUnit    String?   // 容量单位
  status          String    @default("active") // 状态：active、inactive
  remark          String?   // 备注
  
  parent          Location? @relation("LocationHierarchy", fields: [parentId], references: [id])
  children        Location[] @relation("LocationHierarchy")
  
  // 库存移动关系
  fromMovements   InventoryMovement[] @relation("FromLocation")
  toMovements     InventoryMovement[] @relation("ToLocation")
  inventoryLevels InventoryLevel[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("locations")
}

// 8. 库存调整
model InventoryAdjustment {
  id            String    @id @default(cuid())
  productId     String    // 产品ID
  type          String    // 类型：increase或decrease
  quantity      Decimal   @db.Decimal(10, 3) // 调整数量
  unitCost      Decimal?  @db.Decimal(10, 2) // 单位成本
  totalCost     Decimal?  @db.Decimal(10, 2) // 总成本
  reason        String    // 原因
  remark        String?   // 备注
  createdById   String    // 创建人
  
  product       Product   @relation(fields: [productId], references: [id])
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("inventory_adjustments")
}

// 9. 库存水平
model InventoryLevel {
  id              String    @id @default(cuid())
  productId       String    // 产品ID
  locationId      String    // 位置ID
  batchId         String?   // 批次ID
  quantity        Decimal   @db.Decimal(10, 3) // 库存数量
  reservedQuantity Decimal  @default(0) @db.Decimal(10, 3) // 预留数量
  availableQuantity Decimal @default(0) @db.Decimal(10, 3) // 可用数量
  unitCost        Decimal?  @db.Decimal(10, 2) // 单位成本
  totalCost       Decimal?  @db.Decimal(10, 2) // 总成本
  
  product         Product   @relation(fields: [productId], references: [id])
  location        Location  @relation(fields: [locationId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([productId, locationId, batchId])
  @@map("inventory_levels")
}

// 10. 库存移动
model InventoryMovement {
  id              String    @id @default(cuid())
  productId       String    // 产品ID
  batchId         String?   // 批次ID
  movementType    String    // 移动类型：inbound、outbound、transfer
  sourceType      String    // 来源类型：purchase、production、adjustment、transfer
  sourceReference String    // 来源引用（如采购单号、加工单号等）
  quantity        Decimal   @db.Decimal(10, 3) // 移动数量
  unitCost        Decimal?  @db.Decimal(10, 2) // 单位成本
  totalCost       Decimal?  @db.Decimal(10, 2) // 总成本
  fromLocationId  String?   // 来源位置ID
  toLocationId    String?   // 目标位置ID
  
  product         Product   @relation(fields: [productId], references: [id])
  fromLocation    Location? @relation("FromLocation", fields: [fromLocationId], references: [id])
  toLocation      Location? @relation("ToLocation", fields: [toLocationId], references: [id])
  
  createdAt       DateTime  @default(now())
  
  @@map("inventory_movements")
}

// 11. 操作日志
model OperationLog {
  id            String        @id @default(cuid())
  userId        String        // 操作用户ID
  userName      String        // 操作用户姓名
  module        String        // 操作模块
  operationType OperationType // 操作类型
  objectId      String        // 操作对象ID
  objectType    String        // 操作对象类型
  oldValue      Json?         // 修改前的值（JSON格式）
  newValue      Json?         // 修改后的值（JSON格式）
  description   String        // 操作描述
  
  createdAt     DateTime      @default(now())
  
  @@map("operation_logs")
}
